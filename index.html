<!DOCTYPE html>
<html lang="hu"> <!-- Changed to Hungarian -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pénzügyi Tudatosság Játék</title> <!-- Translated -->
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* ================================================================== */
        /* 1. ROOT VARIABLES (Updated from Image) */
        /* ================================================================== */
        :root {
            /* Colors (New Palette) */
            --primary-300: #F4E9DB; /* Light beige (buttons) */
            --primary-500: #E88C3A; /* Orange (social gauge, debt bar) */
            --primary-700: #B45309; /* Dark orange (primary button, text) */
            
            --secondary-300: #D9F2F1; /* Light teal (icon bg) */
            --secondary-500: #4EB5B2; /* Teal (well-being gauge, money bar) */
            --secondary-700: #0F766E; /* Dark teal (icon) */
            
            --accent-300: #F49DB8; /* (Unused) */
            --accent-500: #E8467B; /* (Unused) */
            --accent-700: #A61E4D; /* (Unused) */
            
            --bg: #FAF7F5; /* New background cream */
            --surface: #FFFFFF;
            --surface-alt: #F5F7FA;
            --border: #EBE5E0; /* New lighter border */
            
            --text: #1F2937;
            --text-2: #4B5563;
            --text-muted: #B45309; /* Using dark orange for muted text */
            --text-inverse: #FFFFFF;
            
            --success: #2F9E44;
            --warning: #F59F00;
            --error: #D94747; /* Red for 'Don't pay' button */
            --info: #2563EB; /* (Unused) */

            /* Typography */
            --font-main: "Inter", system-ui, sans-serif;
            --font-alt: "Nunito", sans-serif;
            --fs-body: 16px;
            --fs-sm: 14px;
            --fs-lg: 18px;
            --fs-xl: 20px;
            --fs-h2: 24px;
            --fs-h1: 32px;
            --fw-normal: 400;
            --fw-bold: 600;

            /* Spacing & Radius */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-6: 24px;
            --radius-card: 16px;
            --radius-pill: 9999px;
            --radius-btn: 8px;

            /* Shadow */
            --shadow-card: 0 4px 14px rgba(17, 24, 39, 0.08);

            /* Transitions */
            --transition: 180ms ease;
            --transition-long: 500ms ease;
        }

        /* ================================================================== */
        /* 2. GLOBAL & UTILITY STYLES */
        /* ================================================================== */
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            font-size: var(--fs-body);
            font-weight: var(--fw-normal);
            color: var(--text);
            background-color: var(--bg);
            line-height: 1.6;
            position: relative; /* For background shapes */
            overflow-x: hidden; /* For background shapes */
        }

        /* Decorative Background Shapes */
        body::before, body::after {
            content: '';
            position: absolute;
            width: 70vw;
            height: 70vw;
            max-width: 800px;
            max-height: 800px;
            opacity: 0.2;
            z-index: -1;
        }

        body::before {
            background-color: var(--secondary-500);
            top: 0;
            right: -20vw;
            transform: rotate(45deg);
        }
        
        body::after {
            background-color: var(--primary-500);
            top: -10vw;
            right: -10vw;
            transform: rotate(60deg);
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-4);
            position: relative; /* To be on top of bg shapes */
            z-index: 1;
        }

        h1, h2 {
            font-family: var(--font-alt);
            font-weight: var(--fw-bold);
            color: var(--text-2);
            margin-bottom: var(--space-3);
        }
        h1 { font-size: var(--fs-h1); }
        h2 { font-size: var(--fs-h2); }
        p { margin-bottom: var(--space-4); }

        /* ================================================================== */
        /* 3. COMPONENTS (Updated from Image) */
        /* ================================================================== */

        .card {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-card);
            padding: var(--space-6);
        }

        .btn {
            font-family: var(--font-main);
            font-size: var(--fs-body);
            font-weight: var(--fw-bold);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-btn);
            border: 1px solid transparent;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: var(--transition);
        }
        .btn:disabled {
            background-color: var(--border);
            border-color: var(--border);
            color: var(--text-muted);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn:focus-visible {
            outline: 3px solid var(--secondary-300);
            outline-offset: 2px;
        }
        
        .btn-primary {
            background-color: var(--primary-700);
            color: var(--text-inverse);
            border-color: var(--primary-700);
        }
        .btn-primary:hover:not(:disabled) {
            filter: brightness(110%);
        }

        .btn-secondary {
            background-color: var(--surface);
            color: var(--primary-700);
            border-color: var(--primary-300);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--primary-300);
        }

        .btn-accent {
            background-color: var(--surface);
            color: var(--error);
            border-color: var(--error);
            display: flex; /* For 'x' icon */
            justify-content: center; /* <<< FIX */
            align-items: center;
        }
        .btn-accent:hover:not(:disabled) {
            background-color: rgba(217, 71, 71, 0.05);
        }
        .btn-accent::after {
            content: '×';
            font-size: 24px;
            font-weight: bold;
            line-height: 1;
            margin-left: var(--space-2);
        }

        .input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-size: var(--fs-body);
            border: 1px solid var(--border);
            border-radius: var(--radius-btn);
            transition: var(--transition);
        }
        .input:focus {
            border-color: var(--secondary-500);
            box-shadow: 0 0 0 2px var(--secondary-500); /* Focus Ring */
            outline: none;
        }

        /* ================================================================== */
        /* 4. LOGIN SCREEN (Updated) */
        /* ================================================================== */
        
        #login-screen {
            min-height: 100vh;
            display: grid;
            place-items: center;
            padding: var(--space-6) 0; /* Add padding for long content on mobile */
        }

        .login-card {
            width: 100%;
            max-width: 550px; /* Increased max-width for new content */
            text-align: center;
        }
        .login-card h1 {
            color: var(--primary-700);
            margin-bottom: var(--space-4);
        }
        
        /* New Styles for Summary & Persona */
        .login-card h2 {
            font-family: var(--font-alt);
            font-weight: var(--fw-bold);
            color: var(--primary-700);
            margin-top: var(--space-6);
            margin-bottom: var(--space-3);
            text-align: left;
            font-size: var(--fs-xl);
            border-bottom: 1px solid var(--border);
            padding-bottom: var(--space-2);
        }

        .login-card .summary-text {
            text-align: left;
            font-size: var(--fs-body);
            color: var(--text-2);
            margin-bottom: var(--space-4);
            line-height: 1.7;
        }

        .persona-choices {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        .btn-persona {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
            border: 2px solid var(--primary-300);
            background-color: var(--surface);
            color: var(--primary-700);
            border-radius: var(--radius-btn);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-persona svg {
            width: 48px;
            height: 48px;
            margin-bottom: var(--space-2);
            fill: var(--primary-700);
            transition: var(--transition);
        }

        .btn-persona span {
            font-size: var(--fs-lg);
            font-weight: var(--fw-bold);
        }

        .btn-persona.active {
            background-color: var(--primary-300);
            border-color: var(--primary-700);
            box-shadow: 0 4px 10px rgba(180, 83, 9, 0.1);
        }
        .btn-persona.active svg {
            fill: var(--primary-700);
        }

        .btn-persona:not(.active):hover {
            background-color: var(--bg);
            border-color: var(--primary-500);
        }
        
        .login-card label {
            display: block; 
            text-align: left; 
            font-weight: 600; 
            margin-bottom: 8px;
            color: var(--text-2);
        }
        
        .start-button-container {
            margin-top: var(--space-6);
            display: grid;
        }

        .start-button-container .btn-primary {
            font-size: var(--fs-lg);
            padding: var(--space-4);
        }

        /* ================================================================== */
        /* 5. MAIN GAME UI (Updated from Image) */
        /* ================================================================== */

        .game-header {
            padding: var(--space-4) 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* border-bottom: 1px solid var(--border); */ /* Removed border */
            margin-bottom: var(--space-6);
        }
        
        #game-date {
            font-family: var(--font-alt);
            font-size: var(--fs-h2);
            font-weight: var(--fw-bold);
            color: var(--primary-700);
        }
        
        .header-buttons {
            display: flex;
            gap: var(--space-3);
        }
        /* Override for header buttons */
        .header-buttons .btn-secondary {
            background-color: var(--primary-300);
            color: var(--primary-700);
            border-color: var(--primary-300);
        }
        .header-buttons .btn-secondary:hover {
            filter: brightness(105%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: var(--space-6);
            margin-bottom: var(--space-6);
            align-items: end; /* Aligns all items to bottom */
        }

        .stat-label {
            text-align: center;
            font-size: var(--fs-lg);
            font-weight: var(--fw-bold);
            font-family: var(--font-alt);
            color: var(--text-2);
            margin-top: var(--space-3);
        }

        /* --- NEW Segmented Bars (Money & Debt) --- */
        .bar-label-top {
            text-align: center;
            font-size: var(--fs-lg);
            font-weight: var(--fw-bold);
            color: var(--text-2);
            margin-bottom: var(--space-2);
            font-family: var(--font-alt);
        }

        .bar-container-segmented {
            display: flex;
            flex-direction: column-reverse; /* Stacks from bottom */
            gap: 4px;
            width: 80px; /* "twice the width in the app as in the pic" */
            margin: 0 auto; /* Center the bar */
            height: 300px; /* Fixed height for 20 segments */
            padding: var(--space-2);
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-btn);
        }

        .bar-segment {
            height: 12px;
            width: 100%;
            background-color: var(--border);
            border-radius: 4px;
            transition: background-color var(--transition-long);
        }

        .bar-segment.filled-money {
            background-color: var(--secondary-500);
        }
        
        .bar-segment.filled-debt {
            background-color: var(--primary-500);
        }
        
        /* --- Circular Gauges (Social & Well-being) --- */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; /* For icon wrapper */
        }

        /* NEW Gauge Icon */
        .gauge-icon-wrapper {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            margin-bottom: -22px; /* Pulls icon down over gauge */
            position: relative;
            z-index: 10;
            border: 4px solid var(--bg);
        }
        .gauge-icon-wrapper svg {
            width: 24px;
            height: 24px;
        }

        #social-gauge-wrapper {
            background-color: var(--primary-300);
        }
        #social-gauge-wrapper svg {
            fill: var(--primary-700);
        }
        #wellbeing-gauge-wrapper {
            background-color: var(--secondary-300);
        }
        #wellbeing-gauge-wrapper svg {
            fill: var(--secondary-700);
        }


        .gauge-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            background-color: var(--surface-alt);
            --p: 50; /* Percent */
            transition: background-image var(--transition-long);
        }
        
        .gauge-circle::before {
            content: '';
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background-color: var(--surface);
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
        }

        .gauge-percent {
            position: absolute;
            font-size: var(--fs-h1);
            font-weight: var(--fw-bold);
            font-family: var(--font-alt);
            transition: color var(--transition-long);
        }
        
        #social-gauge { 
            background-image: conic-gradient(var(--primary-500) calc(var(--p-social, 50) * 1%), var(--border) 0); 
        }
        #social-gauge .gauge-percent { color: var(--primary-500); } /* Updated color */

        #wellbeing-gauge { 
            background-image: conic-gradient(var(--secondary-500) calc(var(--p-wellbeing, 50) * 1%), var(--border) 0); 
        }
        #wellbeing-gauge .gauge-percent { color: var(--secondary-500); } /* Updated color */


        /* --- Event Panel --- */
        #event-panel {
            max-width: 800px;
            margin: 0 auto;
        }

        #event-card {
            min-height: 150px;
            text-align: center;
        }
        
        #event-title {
            font-size: var(--fs-lg);
            font-weight: var(--fw-bold);
            color: var(--text-2);
            margin-bottom: var(--space-4);
        }

        #event-message {
            font-size: var(--fs-xl);
            font-family: var(--font-alt);
            color: var(--text);
            line-height: 1.4;
        }

        #event-choices {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        /* ================================================================== */
        /* 6. MODAL STYLES */
        /* ================================================================== */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(31, 41, 55, 0.7); /* --text with alpha */
            display: grid;
            place-items: center;
            z-index: 100;
        }

        .modal-card {
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        /* Wider modal for table */
        .modal-card.modal-lg {
             max-width: 800px;
        }


        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        .modal-body {
            overflow-y: auto;
            padding-right: var(--space-2); /* for scrollbar */
        }
        
        .btn-modal-close {
            font-size: var(--fs-h2);
            font-weight: var(--fw-bold);
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--border);
        }
        .log-item:last-child {
            border-bottom: none;
        }
        .log-item-info {
            font-size: var(--fs-lg);
        }
        .log-item-info strong {
            color: var(--text-2);
        }
        .log-item-info span {
            color: var(--error);
            font-weight: var(--fw-bold);
        }
        .log-item-actions .btn {
            padding: var(--space-2) var(--space-3);
        }

        /* NEW Modal Error Style */
        .modal-error {
            color: var(--error);
            font-weight: var(--fw-bold);
            text-align: center;
            margin-top: var(--space-3);
            min-height: 1.5em; /* Prevent layout shift */
        }
        
        /* NEW Obligatory Table Styles */
        .obligatory-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-4);
        }
        .obligatory-table th, .obligatory-table td {
            text-align: left;
            padding: var(--space-3);
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        .obligatory-table th {
            font-family: var(--font-alt);
            color: var(--text-2);
        }
        .obligatory-table .cost-amount {
            font-weight: var(--fw-bold);
            color: var(--primary-700);
            white-space: nowrap;
        }
        .obligatory-actions {
            display: flex;
            gap: var(--space-2);
            min-width: 220px; /* Prevent wrapping */
        }
        .obligatory-actions .btn {
            padding: var(--space-1) var(--space-2);
            font-size: var(--fs-sm);
            flex: 1;
        }
        
        /* Status shown after processing a row */
        .obligatory-status {
            font-weight: var(--fw-bold);
            font-style: italic;
            font-size: var(--fs-lg);
        }
        .status-paid { color: var(--success); }
        .status-deferred { color: var(--warning); }
        .status-denied { color: var(--error); }
        
        .modal-footer {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
        }
    
    </style>
</head>
<body>

    <!-- Translated Login Screen -->
    <div id="login-screen">
        <div class="card login-card">
            <h1>Üdv a Játékban!</h1>
            
            <h2>A helyzetetek</h2>
            <p class="summary-text">
                Egy négyfős család vagytok, egy bérelt lakásban éltek Budapest 14. kerületében (Zugló).
                <br><br>
                Két gyermeketek van, 14 és 18 évesek (egy középiskolás, egy pedig egyetemista).
                <br><br>
                Egyikőtök banki ügyintéző, másikótok irodai dolgozó. A célotok, hogy kezeljétek a család havi pénzügyeit, nehéz döntéseket hozzatok, és a 'Pénz', 'Közösség' és 'Jólét' mutatóit nulla felett tartsátok.
                <br><br>
                Sok sikert!
            </p>

            <h2>Válassz karaktert</h2>
            <div class="persona-choices">
                <button id="persona-male" class="btn-persona active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4m0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4" /></svg>
                    <span>Férfi</span>
                </button>
                <button id="persona-female" class="btn-persona">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4m0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4" /></svg>
                    <span>Nő</span>
                </button>
            </div>
            
            <label for="nickname">Adj meg egy családnevet:</label>
            <input type="text" id="nickname" class="input" placeholder="pl. 'A Kovács család'">

            <div class="start-button-container">
                <button id="start-game" class="btn btn-primary">Játék Indítása</button>
            </div>
        </div>
    </div>

    <!-- Translated Game Screen -->
    <div id="game-screen" class="hidden">
        
        <header class="game-header container">
            <div id="game-date">Év 1, Január</div>
            <div class="header-buttons">
                <button id="btn-log" class="btn btn-secondary">Eseménynapló</button>
                <button id="btn-debt" class="btn btn-secondary">Adósságlista</button>
            </div>
        </header>

        <main class="container">
            
            <section class="stats-grid">
                
                <div>
                    <div id="money-label" class="bar-label-top">0 Ft</div>
                    <div id="money-bar-container" class="bar-container-segmented">
                        <!-- JS will populate segments -->
                    </div>
                    <div class="stat-label">Pénz</div>
                </div>
                
                <div class="gauge-container">
                    <div id="social-gauge-wrapper" class="gauge-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M14.6 8.36H9.4V6.5h5.2v1.86ZM21.5 12.27v4.46c0 .73-.1 1.44-.31 2.11-.21.68-.52 1.3-.92 1.88-.4.58-.88 1.07-1.44 1.47-.56.4-1.18.7-1.85.91-.67.2-1.37.3-2.1.3s-1.43-.1-2.1-.3c-.67-.2-1.29-.5-1.85-.91-.56-.4-1.04-.89-1.44-1.47-.4-.58-.71-1.2-.92-1.88-.21-.67-.31-1.38-.31-2.11v-4.46c0-.73.1-1.44.31-2.11.21-.68.52 1.3.92-1.88.4-.58.88-1.07 1.44-1.47.56-.4 1.18-.7-1.85-.91.67.2 1.37-.3 2.1-.3s1.43.1 2.1.3c.67.2 1.29.5 1.85.91.56.4 1.04.89 1.44 1.47.4.58.71 1.2.92 1.88.21.67.31 1.38.31 2.11Zm-1.86 4.46c0-.44-.04-.88-.13-1.31-.09-.43-.23-.84-.42-1.23-.19-.39-.42-.76-.71-1.1-.29-.34-.63-.65-.99-.93-.3-.23-.62-.43-.96-.59-.34-.16-.7-.29-1.07-.38-.37-.09-.75-.14-1.13-.14s-.76.05-1.13.14c-.37.09-.72.22-1.07.38-.34.16-.66.36-.96.59-.36.28-.7.59-1 .93-.29.34-.52.71-.71 1.1-.19.39-.33.8-.42 1.23-.09.43-.13.87-.13 1.31v4.4c0 .44.04.88.13 1.31.09.43.23.84.42 1.23.19.39.42.76.71 1.1.29.34.63.65.99.93.3.23.62.43.96.59.34.16.7.29 1.07.38.37.09.75.14 1.13.14s.76-.05 1.13-.14c.37-.09.72-.22 1.07-.38.34-.16.66.36.96.59.36.28.7.59 1 .93.29.34.52.71-.71 1.1.19.39.33.8.42 1.23.09.43.13.87.13 1.31v-4.4Z"/>
                        </svg>
                    </div>
                    <div id="social-gauge" class="gauge-circle"> 
                        <div id="social-percent" class="gauge-percent">50%</div>
                    </div>
                    <div class="stat-label">Közösség</div>
                </div>
                
                <div class="gauge-container">
                    <div id="wellbeing-gauge-wrapper" class="gauge-icon-wrapper">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12.38 21.5c-1.3-.23-2.53-.69-3.68-1.37-1.15-.68-2.14-1.55-2.98-2.61-.7-1.05-1.22-2.22-1.54-3.5-.32-1.28-.48-2.6-.48-3.95 0-1.28.15-2.52.44-3.71.3-1.2.78-2.31 1.44-3.34.66-1.03 1.48-1.92 2.45-2.67.97-.75 2.05-1.33 3.25-1.74.6-.2 1.21-.34 1.84-.41.63-.07 1.27-.07 1.91 0 .64.07 1.25.21 1.84.41 1.2.41 2.28.99 3.25 1.74.97.75 1.79 1.64 2.45 2.67.66 1.03 1.15 2.14 1.44 3.34.3 1.19.44 2.43.44 3.71 0 1.35-.16 2.67-.48 3.95-.32 1.28-.84 2.45-1.54 3.5-1.01 1.28-2.28 2.26-3.79 2.94-1.02.47-2.07.8-3.15.99-.44.07-.88.11-1.32.11-.47 0-.93-.05-1.4-.14Zm-1.12-4.11c.36.16.73.28 1.12.38.39.09.78.14 1.18.14.38 0 .76-.04 1.13-.11.37-.08.73-.2 1.08-.36.68-.32 1.3-.74 1.84-1.27.54-.53.98-1.13 1.32-1.81.34-.68.58-1.4.71-2.18.13-.77.2-1.56.2-2.37s-.07-1.6-.2-2.37c-.13-.77-.37-1.5-.71-2.18-.34-.68-.78-1.28-1.32-1.81-.54-.53-1.16-.95-1.84-1.27-.35-.16-.71-.28-1.08-.36-.37-.07-.75-.11-1.13-.11-.4 0-.79.05-1.18.14-.39.1-.76.22-1.12.38-.9.4-1.68.99-2.32 1.75-.64.76-1.13 1.65-1.47 2.66-.34 1.01-.51 2.08-.51 3.21 0 1.13.17 2.2.51 3.21.34 1.01.83 1.9 1.47 2.66.64.76 1.42 1.35 2.32 1.75Z"/>
                        </svg>
                    </div>
                    <div id="wellbeing-gauge" class="gauge-circle"> 
                        <div id="wellbeing-percent" class="gauge-percent">50%</div>
                    </div>
                    <div class="stat-label">Jólét</div>
                </div>

                <div>
                    <div id="debt-label" class="bar-label-top">0 Ft</div>
                    <div id="debt-bar-container" class="bar-container-segmented">
                         <!-- JS will populate segments -->
                    </div>
                    <div class="stat-label">Adósság</div>
                </div>

            </section>

            <!-- Event Panel is now just for non-obligatory events -->
            <section id="event-panel" class="hidden"> <!-- Start hidden -->
                <div class="card" id="event-card">
                    <div id="event-title">Esemény Címe</div>
                    <div id="event-message">
                        Ide kerül az esemény leírása.
                    </div>
                </div>
                <div id="event-choices">
                    </div>
            </section>

        </main>
    </div>

    <!-- Translated Modals -->
    <div id="log-modal" class="modal-overlay hidden">
        <div class="card modal-card">
            <div class="modal-header">
                <h2>Elhalasztott események</h2>
                <button id="btn-log-close" class="btn-modal-close">&times;</button>
            </div>
            <div id="log-modal-body" class="modal-body">
                <!-- JS populates this -->
            </div>
            <div id="log-modal-error" class="modal-error"></div> <!-- Added error field -->
        </div>
    </div>

    <div id="debt-modal" class="modal-overlay hidden">
        <div class="card modal-card">
            <div class="modal-header">
                <h2>Fennálló adósságok</h2>
                <button id="btn-debt-close" class="btn-modal-close">&times;</button>
            </div>
            <div id="debt-modal-body" class="modal-body">
                <!-- JS populates this -->
            </div>
            <div id="debt-modal-error" class="modal-error"></div> <!-- Added error field -->
        </div>
    </div>

    <!-- NEW: Obligatory Costs Modal -->
    <div id="obligatory-modal" class="modal-overlay hidden">
        <div class="card modal-card modal-lg"> <!-- Wide modal -->
            <div class="modal-header">
                <h2>Havi Kötelező Költségek</h2>
                <!-- No close button, must process all -->
            </div>
            <div id="obligatory-modal-body" class="modal-body">
                <table class="obligatory-table">
                    <thead>
                        <tr>
                            <th>Költség</th>
                            <th>Összeg</th>
                            <th>Akció</th>
                        </tr>
                    </thead>
                    <tbody id="obligatory-table-body">
                        <!-- JS populates this -->
                    </tbody>
                </table>
            </div>
            <div id="obligatory-modal-error" class="modal-error"></div>
            <div class="modal-footer">
                <button id="btn-obligatory-continue" class="btn btn-primary" disabled>Tovább a hónap eseményeihez</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // ==================================================================
        // 1. DOM ELEMENTS (Updated for new UI)
        // ==================================================================
        const loginScreen = document.getElementById('login-screen');
        const gameScreen = document.getElementById('game-screen');
        const startGameBtn = document.getElementById('start-game');
        const nicknameInput = document.getElementById('nickname');
        const personaMaleBtn = document.getElementById('persona-male');
        const personaFemaleBtn = document.getElementById('persona-female');

        const gameDate = document.getElementById('game-date');
        const moneyLabel = document.getElementById('money-label');
        const moneyBarContainer = document.getElementById('money-bar-container'); // Changed
        const debtLabel = document.getElementById('debt-label');
        const debtBarContainer = document.getElementById('debt-bar-container'); // Changed
        
        const socialPercent = document.getElementById('social-percent');
        const socialGauge = document.getElementById('social-gauge');
        const wellbeingPercent = document.getElementById('wellbeing-percent');
        const wellbeingGauge = document.getElementById('wellbeing-gauge');

        const eventPanel = document.getElementById('event-panel'); // Get panel itself
        const eventTitle = document.getElementById('event-title');
        const eventMessage = document.getElementById('event-message');
        const eventChoices = document.getElementById('event-choices');

        const logModal = document.getElementById('log-modal');
        const debtModal = document.getElementById('debt-modal');
        const btnLog = document.getElementById('btn-log');
        const btnDebt = document.getElementById('btn-debt');
        const btnLogClose = document.getElementById('btn-log-close');
        const btnDebtClose = document.getElementById('btn-debt-close');
        const logModalBody = document.getElementById('log-modal-body');
        const debtModalBody = document.getElementById('debt-modal-body');

        // New Obligatory Modal Elements
        const obligatoryModal = document.getElementById('obligatory-modal');
        const obligatoryTableBody = document.getElementById('obligatory-table-body');
        const obligatoryModalError = document.getElementById('obligatory-modal-error');
        const btnObligatoryContinue = document.getElementById('btn-obligatory-continue');

        // Error message fields
        const logModalError = document.getElementById('log-modal-error');
        const debtModalError = document.getElementById('debt-modal-error');


        // ==================================================================
        // 2. GAME STATE (Translated)
        // ==================================================================
        let gameState = {
            nickname: "",
            money: 0,
            debt: 0,
            social: 50,
            well_being: 50,
            currentYear: 1,
            currentMonth: 0, // 0 = Január
            debtHistory: [], // { event, amount, month }
            snoozedEvents: [], // { event }
            monthlyEventQueue: [],
            // Translated monthNames
            monthNames: ["Január", "Február", "Március", "Április", "Május", "Június", "Július", "Augusztus", "Szeptember", "Október", "November", "December"],
            salary: 1126600,
            maxMoney: 1500000, 
            maxDebt: 1000000,
            cheapFoodStreak: 0,
            consecutiveDebtMonths: 0, 
            carSold: false,
            recurringCosts: [] 
        };
        
        // NEW State variables for obligatory modal
        let processedObligatoryCount = 0;
        let totalObligatoryCosts = 0;

        // ==================================================================
        // 3. THE EVENT DATABASE (TRANSLATED + ALL NEW EVENTS)
        // ==================================================================
        const allEvents = {
            // === KÖTELEZŐ (Dupla statok) ===
            // These are now handled by the modal
            obligatory: [
                { id: "insurance", title: "Lakásbiztosítás", message: "Esedékes a havi lakásbiztosítási díj.", type: "obligatory", amount: 4000, dayOfMonth: 1,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 0, well_being: 5 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: 0, well_being: -2 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: 0, well_being: -8 }, action: "add_to_debt" }
                    ]
                },
                { id: "bkk_pass", title: "Havi bérletek", message: "Itt az ideje megvenni a bérleteket a munkába és iskolába járáshoz.", type: "obligatory", amount: 26000, dayOfMonth: 1,
                    choices: [
                        { id: "pay", text: "Bérletvásárlás", effects: { money_multiplier: -1, social: 2, well_being: 3 }, action: null },
                        { id: "later", text: "Várok pár napot", effects: { money_multiplier: 0, social: -6, well_being: -10 }, action: "defer" },
                        { id: "deny", text: "Nem veszek (jegyek)", effects: { money_multiplier: 0, social: -16, well_being: -20 }, action: "add_to_debt" }
                    ]
                },
                { id: "fuel", title: "Havi üzemanyag", message: "Tankolni kell az autóba az ingázáshoz és a bevásárláshoz.", type: "obligatory", amount: 35000, dayOfMonth: 2,
                    choices: [
                        { id: "pay", text: "Tankolás", effects: { money_multiplier: -1, social: 2, well_being: 4 }, action: null },
                        { id: "later", text: "Várok (gőzökön járok)", effects: { money_multiplier: 0, social: -4, well_being: -8 }, action: "defer" },
                        { id: "deny", text: "Nem tankolok (autó parkol)", effects: { money_multiplier: 0, social: -10, well_being: -16 }, action: "add_to_debt" }
                    ]
                },
                { id: "rent", title: "Albérlet", message: "Telefonált a főbérlő - ideje fizetni a lakbért.", type: "obligatory", amount: 220000, dayOfMonth: 5,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 5, well_being: 8 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -6, well_being: -10 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: -20, well_being: -30 }, action: "add_to_debt" }
                    ]
                },
                { id: "common_cost", title: "Közös költség", message: "Megjött a havi közös költség csekkje.", type: "obligatory", amount: 21000, dayOfMonth: 10,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 2, well_being: 2 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -6, well_being: -6 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: -16, well_being: -16 }, action: "add_to_debt" }
                    ]
                },
                { id: "menza", title: "Iskolai ebéd (Menza)", message: "Az iskola kéri a befizetést mindkét gyerek havi étkezésére.", type: "obligatory", amount: 25000, dayOfMonth: 10,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 5, well_being: 3 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -10, well_being: -10 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: -30, well_being: -20 }, action: "add_to_debt" }
                    ]
                },
                { id: "car_insurance", title: "Kötelező biztosítás (KGFB)", message: "Esedékes az autó kötelező biztosításának havi részlete.", type: "obligatory", amount: 5000, dayOfMonth: 12,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 0, well_being: 2 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -2, well_being: -4 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem (Büntetés)", effects: { money_multiplier: 0, social: -20, well_being: -20 }, action: "add_to_debt" }
                    ]
                },
                { id: "car_tax", title: "Gépjárműadó", message: "Ki kell fizetni a gépjárműadó havi átlagolt részletét ('súlyadó').", type: "obligatory", amount: 2000, dayOfMonth: 12,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 0, well_being: 2 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -2, well_being: -2 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: -10, well_being: -10 }, action: "add_to_debt" }
                    ]
                },
                { id: "water", title: "Vízszámla", message: "Megjött a havi vízdíj számla.", type: "obligatory", amount: 3000, dayOfMonth: 15,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 2, well_being: 3 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -2, well_being: -6 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: -8, well_being: -16 }, action: "add_to_debt" }
                    ]
                },
                { id: "internet", title: "Internet számla", message: "Esedékes az internet számla. A gyerekek nem tudnak tanulni nélküle.", type: "obligatory", amount: 8000, dayOfMonth: 15,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 4, well_being: 5 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -4, well_being: -8 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: -20, well_being: -20 }, action: "add_to_debt" }
                    ]
                },
                { id: "electricity", title: "Villanyszámla", message: "Megjött a villanyszámla.", type: "obligatory", amount: 22000, dayOfMonth: 18,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 2, well_being: 3 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -2, well_being: -10 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: -10, well_being: -20 }, action: "add_to_debt" }
                    ]
                },
                { id: "gas", title: "Gázszámla", message: "Megjött a gázszámla (fűtés, melegvíz, főzés).", type: "obligatory", amount: 25000, dayOfMonth: 20,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 2, well_being: 5 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -4, well_being: -12 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: -12, well_being: -30 }, action: "add_to_debt" }
                    ]
                },
                { id: "mobile", title: "Telefonszámlák", message: "Megjött a család mobilszámlája.", type: "obligatory", amount: 18000, dayOfMonth: 22,
                    choices: [
                        { id: "pay", text: "Fizetés most", effects: { money_multiplier: -1, social: 3, well_being: 2 }, action: null },
                        { id: "later", text: "Fizetés később", effects: { money_multiplier: 0, social: -6, well_being: -6 }, action: "defer" },
                        { id: "deny", text: "Nem fizetem ki", effects: { money_multiplier: 0, social: -20, well_being: -16 }, action: "add_to_debt" }
                    ]
                },
                { id: "bank_fees", title: "Banki költségek", message: "A bank levonta a havi számlavezetési díjakat.", type: "obligatory", amount: 5000, dayOfMonth: 28,
                    choices: [
                        { id: "pay", text: "Tudomásul veszem", effects: { money_multiplier: -1, social: 0, well_being: 0 }, action: null },
                        { id: "later", text: "Vitatom (később fizetem)", effects: { money_multiplier: 0, social: -2, well_being: -4 }, action: "defer" },
                        { id: "deny", text: "Számla lezárása (nem fizetem)", effects: { money_multiplier: 0, social: -8, well_being: -10 }, action: "add_to_debt" }
                    ]
                }
            ],
            // === KÜLÖNLEGES (Dupla költség, dupla stat) ===
            special: [
                {
                    id: "groceries", title: "Havi nagybevásárlás", message: "Itt az ideje a havi nagybevásárlásnak. Mi a terv a család élelmezésére?", type: "choice", dayOfMonth: 8,
                    choices: [
                        { id: "quality", text: "Jó minőségű, egészséges étel (560 000 Ft)", effects: { money: -560000, social: 10, well_being: 20 }, action: "quality_food" },
                        { id: "cheap", text: "Olcsó, feldolgozott élelmiszer (336 000 Ft)", effects: { money: -336000, social: -12, well_being: -30 }, action: "cheap_food" }
                    ]
                }
            ],
            // === OPCIONÁLIS (Dupla stat + 15 NEW EVENTS) ===
            optional: [
                { id: "opt_pizza", title: "Pizza este", message: "Mindenki fáradt. Rendeljünk pizzát ma estére az egész családnak?", type: "optional", amount: 15000, dayOfMonth: 12, effects_yes: { social: 10, well_being: 12 }, effects_no: { social: 0, well_being: 0 } },
                { id: "opt_cinema", title: "Mozi", message: "Van egy új film, amit mindenki meg akar nézni. Elmenjünk a hétvégén moziba?", type: "optional", amount: 15000, dayOfMonth: 19, effects_yes: { social: 12, well_being: 10 }, effects_no: { social: 0, well_being: 0 } },
                { id: "opt_grandparents", title: "Látogatás a nagyszülőknél", message: "A nagyszülők meghívtak vasárnapi ebédre. Két óra autóval.", type: "optional", amount: 12000, dayOfMonth: 13, effects_yes: { social: 20, well_being: 10 }, effects_no: { social: -6, well_being: 0 } },
                { id: "opt_restaurant", title: "Étterem", message: "Menjünk el egy jó családi vacsorára, nincs főzés, nincs mosogatás!", type: "optional", amount: 20000, dayOfMonth: 26, effects_yes: { social: 14, well_being: 14 }, effects_no: { social: 0, well_being: 0 } },
                { id: "opt_datenight", title: "Szülői randi este", message: "A pároddal ezer éve nem voltatok kettesben. Bébiszitter és egy jó vacsora?", type: "optional", amount: 15000, dayOfMonth: 27, effects_yes: { social: 10, well_being: 20 }, effects_no: { social: 0, well_being: -2 } },
                { id: "opt_fieldtrip", title: "Osztálykirándulás", message: "A 14 éves osztálya 3 napos kirándulást tervez. Be kell fizetni a díjat.", type: "optional", amount: 25000, dayOfMonth: 9, nag: true, effects_yes: { social: 12, well_being: 10 }, effects_no: { social: -8, well_being: -4 } },
                { id: "opt_uniprep", title: "Egyetemi előkészítő", message: "A 18 éves talált egy hétvégi előkészítő kurzust az egyetemi felvételihez.", type: "optional", amount: 30000, dayOfMonth: 11, nag: true, effects_yes: { social: -4, well_being: 10 }, effects_no: { social: 0, well_being: -6 } },
                { id: "opt_bdaygift", title: "Szülinapi ajándék", message: "A 14 évest meghívták egy barátja szülinapi bulijára, ajándékot kell venni.", type: "optional", amount: 15000, dayOfMonth: 16, effects_yes: { social: 8, well_being: 4 }, effects_no: { social: -6, well_being: 0 } },
                { id: "opt_videogame", title: "Új videojáték", message: "A gyerekek spóroltak, de segítséget kérnek egy új, népszerű videojáték megvásárlásához.", type: "optional", amount: 20000, dayOfMonth: 21, nag: true, effects_yes: { social: -4, well_being: 10 }, effects_no: { social: 0, well_being: -4 } },
                { id: "opt_pocketmoney", title: "Zsebpénz emelés", message: "A gyerekek panaszkodnak, hogy nem elég a zsebpénzük.", type: "optional", amount: 20000, dayOfMonth: 3, recurring: true, effects_yes: { social: 10, well_being: 6 }, effects_no: { social: -4, well_being: -4 } },
                { id: "opt_runningshoes", title: "Új futócipő", message: "A régi futócipőd szétszakad. Ideje egy új párnak?", type: "optional", amount: 35000, dayOfMonth: 17, nag: true, effects_yes: { social: 0, well_being: 16 }, effects_no: { social: 0, well_being: -4 } },
                { id: "opt_gym", title: "Konditerem bérlet", message: "Új konditerem nyílt a közelben. Vegyen egyikőtök havi bérletet?", type: "optional", amount: 20000, dayOfMonth: 6, recurring: true, effects_yes: { social: 0, well_being: 14 }, effects_no: { social: 0, well_being: 0 } },
                { id: "opt_streaming", title: "Új streaming szolgáltatás", message: "A kedvenc sorozatod átköltözött egy új streaming szolgáltatóhoz.", type: "optional", amount: 4000, dayOfMonth: 7, recurring: true, effects_yes: { social: 4, well_being: 6 }, effects_no: { social: 0, well_being: -2 } },
                { id: "opt_clothes", title: "Új ruhák vásárlása", message: "Megjöttek az új szezonális ruhák a boltokba. Ideje egy kis vásárlásnak?", type: "optional", amount: 40000, dayOfMonth: 20, effects_yes: { social: 4, well_being: 12 }, effects_no: { social: 0, well_being: -2 } },
                { id: "opt_book", title: "Új könyv vásárlása", message: "Megláttad a kedvenc szerződ új könyvét.", type: "optional", amount: 6000, dayOfMonth: 14, effects_yes: { social: 0, well_being: 8 }, effects_no: { social: 0, well_being: 0 } },
                { id: "opt_washingmachine", title: "Elromlott a mosógép", message: "A mosógép szörnyű hangot ad és nem centrifugál. A szerelő sokba fog kerülni.", type: "optional", amount: 50000, dayOfMonth: 18, effects_yes: { social: 4, well_being: 10 }, effects_no: { social: -16, well_being: -30 } },
                { id: "opt_microwave", title: "Meghalt a mikró", message: "A mikró szikrázott egyet és tönkrement. Vesztek újat?", type: "optional", amount: 30000, dayOfMonth: 23, effects_yes: { social: 2, well_being: 8 }, effects_no: { social: -6, well_being: -12 } },
                { id: "opt_balaton", title: "Hétvégi családi kiruccanás", message: "Jön egy hosszú hétvége. Foglaljatok egy olcsó apartmant a Balatonnál?", type: "optional", amount: 120000, dayOfMonth: 24, effects_yes: { social: 40, well_being: 40 }, effects_no: { social: -10, well_being: -10 } },
                { id: "opt_charity", title: "Adományozás", message: "Egy helyi jótékonysági szervezet gyűjt az állatmenhelynek. Adományoztok?", type: "optional", amount: 5000, dayOfMonth: 25, effects_yes: { social: 10, well_being: 6 }, effects_no: { social: 0, well_being: 0 } },
                { id: "opt_physiotherapy", title: "Gyógytorna", message: "Fáj a hátad az irodai üléstől. Az orvos gyógytornát javasol.", type: "optional", amount: 30000, dayOfMonth: 16, effects_yes: { social: 0, well_being: 20 }, effects_no: { social: 0, well_being: -6 } },
                
                // --- 10 NEW NEGATIVE OPTIONALS ---
                { id: "opt_gymnastics_pass", title: "Tornász bérlet", message: "A 14 évesnek drága tornász bérletre van szüksége az iskolai csapathoz.", type: "optional", amount: 25000, dayOfMonth: 5, nag: true, effects_yes: { social: 10, well_being: 10 }, effects_no: { social: -20, well_being: -10 } },
                { id: "opt_lost_phone", title: "Elveszett telefon", message: "A 18 éves elhagyta a telefonját. Pótolni kell, mert szüksége van rá az egyetemhez.", type: "optional", amount: 150000, dayOfMonth: 14, nag: true, effects_yes: { social: 10, well_being: 0 }, effects_no: { social: -40, well_being: -20 } },
                { id: "opt_sick_pet", title: "Beteg a kutya", message: "A családi kutya beteg, sürgős állatorvosi ellátásra van szüksége.", type: "optional", amount: 40000, dayOfMonth: 12, effects_yes: { social: 0, well_being: 20 }, effects_no: { social: -20, well_being: -30 } },
                { id: "opt_neighbor_leak", title: "Szomszéd beázott", message: "Úgy tűnik, eláztattátok az alsó szomszédot! Ki kell fizetni a javítási díját.", type: "optional", amount: 75000, dayOfMonth: 19, effects_yes: { social: 10, well_being: 0 }, effects_no: { social: -40, well_being: -10 } },
                { id: "opt_wedding_invite", title: "Esküvői meghívó", message: "Meghívtak egy unokatestvér esküvőjére vidékre. (Utazás, ajándék, ruha).", type: "optional", amount: 90000, dayOfMonth: 22, effects_yes: { social: 40, well_being: -10 }, effects_no: { social: -30, well_being: 0 } },
                { id: "opt_textbook", title: "Drága szakkönyv", message: "Az egyetemista gyereknek egy extrém drága, de kötelező szakkönyvre van szüksége.", type: "optional", amount: 28000, dayOfMonth: 9, nag: true, effects_yes: { social: 0, well_being: 10 }, effects_no: { social: -10, well_being: -10 } },
                { id: "opt_theater_tickets", title: "Színházjegyek", message: "A párod meglepett két drága színházjeggyel. Muszáj elmenni?", type: "optional", amount: 30000, dayOfMonth: 17, nag: true, effects_yes: { social: 30, well_being: 20 }, effects_no: { social: -20, well_being: -20 } },
                { id: "opt_subscription_trap", title: "Előfizetési csapda", message: "Kiderült, hogy egy évre előfizettél egy drága szoftverre, amit nem is használsz. A lemondás bonyolult.", type: "optional", amount: 18000, dayOfMonth: 13, effects_yes: { social: 0, well_being: -10 }, effects_no: { social: -10, well_being: -20 } },
                { id: "opt_winter_tires", title: "Téli gumi csere", message: "Itt a szezon, le kell cserélni a téli gumikat. A régiek teljesen elkoptak.", type: "optional", amount: 120000, dayOfMonth: 20, effects_yes: { social: 0, well_being: 40 }, effects_no: { social: -20, well_being: -40 } },
                { id: "opt_class_money", title: "Osztálypénz", message: "Ismét osztálypénzt és alapítványi hozzájárulást kérnek az iskolában.", type: "optional", amount: 10000, dayOfMonth: 6, nag: true, effects_yes: { social: 10, well_being: 0 }, effects_no: { social: -10, well_being: 0 } },

                // --- 5 NEW POSITIVE OPTIONALS ---
                { id: "opt_farmers_market", title: "Piacozás", message: "A helyi termelői piacon olcsón tudsz venni egy nagy adag friss, egészséges zöldséget és gyümölcsöt.", type: "optional", amount: 15000, dayOfMonth: 11, effects_yes: { social: 20, well_being: 30 }, effects_no: { social: 0, well_being: 0 } },
                { id: "opt_board_game", title: "Társasjáték este", message: "Vesztek egy új, leárazott társasjátékot és tartotok egy családi játékestét.", type: "optional", amount: 12000, dayOfMonth: 18, effects_yes: { social: 40, well_being: 20 }, effects_no: { social: 0, well_being: 0 } },
                { id: "opt_local_hike", title: "Közeli kirándulás", message: "Süt a nap! Elmentek kirándulni a közeli hegyekbe (szendvicsek, minimális BKK költség).", type: "optional", amount: 5000, dayOfMonth: 24, effects_yes: { social: 30, well_being: 40 }, effects_no: { social: -10, well_being: -10 } },
                { id: "opt_used_bike", title: "Használt bicikli", message: "Találtál egy jó állapotú, olcsó használt biciklit a 14 évesnek a neten.", type: "optional", amount: 25000, dayOfMonth: 15, effects_yes: { social: 10, well_being: 30 }, effects_no: { social: 0, well_being: 0 } },
                { id: "opt_volunteering", title: "Önkéntes munka", message: "A család elmegy egy napra önkénteskedni egy helyi alapítványnál. (minimális útiköltség)", type: "optional", amount: 2000, dayOfMonth: 26, effects_yes: { social: 60, well_being: 20 }, effects_no: { social: 0, well_being: 0 } }
            ],
            // === LEHETŐSÉG (Dupla stat + 8 NEW EVENTS) ===
            opportunity: [
                { id: "job_neighbor", title: "Szomszéd ajánlata", message: "A szomszéd 20 000 Ft-ot ajánlott az idősebb gyereknek egy egész szombati kemény kerti munkáért.", type: "opportunity", dayOfMonth: 13,
                    choices: [
                        { id: "yes", text: "Elvállalja (+20 000 Ft)", effects: { money: 20000, social: -16, well_being: -10 } },
                        { id: "no", text: "Elutasítja (Szabad hétvége)", effects: { money: 0, social: 4, well_being: 6 } }
                    ]
                },
                { id: "job_freelance_parent", title: "Szabadúszó munka", message: "Egy volt kolléga felajánlott egyikőtöknek (szülő) egy kis szabadúszó projektet. 3 hosszú éjszaka munka, miután a gyerekek elaludtak.", type: "opportunity", dayOfMonth: 19,
                    choices: [
                        { id: "yes", text: "Elvállalom (+45 000 Ft)", effects: { money: 45000, social: -20, well_being: -20 } },
                        { id: "no", text: "Elutasítom (Vigyázok az egészségemre)", effects: { money: 0, social: 0, well_being: 0 } }
                    ]
                },
                { id: "job_overtime", title: "Kötelező túlóra", message: "A főnököd bejelentett egy kritikus projektet. Két teljes hétvégét kell dolgoznod ebben a hónapban. Jól megfizetik.", type: "opportunity", dayOfMonth: 6,
                    choices: [
                        { id: "yes", text: "Vállalom a túlórákat (+75 000 Ft)", effects: { money: 75000, social: -30, well_being: -30 } },
                        { id: "no", text: "Visszautasítom", effects: { money: 0, social: 0, well_being: 0 } }
                    ]
                },
                { id: "job_sell_car", title: "Eladni az autót?", message: "Kétségbeesetten szükségetek van pénzre. Eladhatnátok a családi autót. Ez egy egyszeri nagy bevétel lenne, de utána tömegközlekedésre kellene támaszkodnotok, ami nehezebb gyerekekkel.", type: "opportunity", dayOfMonth: 4,
                    choices: [
                        { id: "yes", text: "Eladom az autót (+500 000 Ft)", effects: { money: 500000, social: -50, well_being: -40 }, action: "sell_car" },
                        { id: "no", text: "Megtartom az autót", effects: { money: 0, social: 0, well_being: 0 } }
                    ]
                },
                { id: "new_tax_refund", title: "Adóvisszatérítés!", message: "Jó hír! Tavaly túlfizettétek az adót. A NAV visszatérítést küldött.", type: "opportunity", dayOfMonth: 11,
                    choices: [
                        { id: "yes", text: "Szuper! (+65 000 Ft)", effects: { money: 65000, social: 5, well_being: 10 } }
                    ]
                },
                // --- 8 NEW INCOME OPPORTUNITIES ---
                { id: "opp_market_research", title: "Piackutatás", message: "Meghívtak egy online piackutatási felmérésre. Kb. 1 óra elfoglaltság.", type: "opportunity", dayOfMonth: 10,
                    choices: [
                        { id: "yes", text: "Részt veszek (+15 000 Ft)", effects: { money: 15000, social: 0, well_being: -4 } }, // Takes time
                        { id: "no", text: "Nincs időm rá", effects: { money: 0, social: 0, well_being: 0 } }
                    ]
                },
                { id: "opp_found_money", title: "Talált pénz", message: "Séta közben találtál egy pénztárcát, benne némi készpénzzel. Nincs benne irat.", type: "opportunity", dayOfMonth: 18,
                    choices: [
                        { id: "yes", text: "Megtartom (+10 000 Ft)", effects: { money: 10000, social: -4, well_being: 4 } }, // Small guilt? Small boost?
                        { id: "no", text: "Leadom a rendőrségen", effects: { money: 0, social: 10, well_being: 10 } } // Feel good action
                    ]
                },
                { id: "opp_utility_refund", title: "Számla visszatérítés", message: "Az egyik közműszolgáltató értesített, hogy túlfizetés miatt visszatérítenek egy kisebb összeget.", type: "opportunity", dayOfMonth: 21,
                    choices: [
                        { id: "yes", text: "Remek hír! (+8 000 Ft)", effects: { money: 8000, social: 4, well_being: 6 } }
                    ]
                },
                { id: "opp_tutoring", title: "Korrepetálás", message: "A szomszéd megkérte az idősebb gyereket, hogy korrepetálja a kisebbiket matekból heti pár órában.", type: "opportunity", dayOfMonth: 7,
                    choices: [
                        { id: "yes", text: "Elvállalja (+20 000 Ft/hó)", effects: { money: 20000, social: -8, well_being: -6 } }, // Less free time
                        { id: "no", text: "Nincs rá ideje", effects: { money: 0, social: 0, well_being: 0 } }
                    ]
                },
                 { id: "opp_relative_gift", title: "Ajándék rokonoktól", message: "Meglátogattak a vidéki rokonok, és adtak egy kis 'konyhapénzt' ajándékba.", type: "opportunity", dayOfMonth: 25,
                    choices: [
                        { id: "yes", text: "Köszönjük szépen! (+25 000 Ft)", effects: { money: 25000, social: 10, well_being: 10 } }
                    ]
                },
                { id: "opp_sell_books", title: "Régi könyvek eladása", message: "Kitakarítottad a polcokat, és egy csomó régi könyvet találtál. El tudod adni őket antikváriumba.", type: "opportunity", dayOfMonth: 14,
                    choices: [
                        { id: "yes", text: "Eladom őket (+7 000 Ft)", effects: { money: 7000, social: 0, well_being: 2 } },
                        { id: "no", text: "Nincs kedvem cipekedni", effects: { money: 0, social: 0, well_being: 0 } }
                    ]
                },
                { id: "opp_cleaning_gig", title: "Takarítás", message: "Egyikőtök (szülő) elvállalhat egy hétvégi takarítási munkát egy barát irodájában.", type: "opportunity", dayOfMonth: 20,
                    choices: [
                        { id: "yes", text: "Elvállalom (+30 000 Ft)", effects: { money: 30000, social: -10, well_being: -16 } }, // Tiring
                        { id: "no", text: "Túl fárasztó", effects: { money: 0, social: 0, well_being: 0 } }
                    ]
                },
                { id: "opp_bank_interest", title: "Kamatjóváírás", message: "A bank egy minimális kamatot jóváírt a látra szóló betéteteken.", type: "opportunity", dayOfMonth: 28,
                    choices: [
                        { id: "yes", text: "Több a semminél... (+1 500 Ft)", effects: { money: 1500, social: 0, well_being: 0 } }
                    ]
                }
            ],
            // === SOKK (Költségek 25%-kal csökkentve, statok duplázva) ===
            shock: [
                { id: "shock_car_repair", title: "Lerobbant az autó", message: "Füstöl az autó motorja... A szerelő szerint a váltó javítása sürgős, és 300 000 Ft-ba fog kerülni.", type: "shock", amount: 300000, dayOfMonth: 15,
                    choices: [
                        { id: "pay", text: "Fizetés a szerelőnek (300 000 Ft)", effects: { money_multiplier: -1, social: -6, well_being: -16 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (később javíttatom)", effects: { money_multiplier: 0, social: -30, well_being: -40 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_pipe_burst", title: "Csőtörés!", message: "Elárasztott fürdőszobára értek haza! A sürgősségi vízvezeték-szerelő díja 225 000 Ft.", type: "shock", amount: 225000, dayOfMonth: 17,
                    choices: [
                        { id: "pay", text: "Fizetés a szerelőnek (225 000 Ft)", effects: { money_multiplier: -1, social: -4, well_being: -20 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (vödrök használata)", effects: { money_multiplier: 0, social: -40, well_being: -50 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_fridge_died", title: "Tönkrement a hűtő", message: "A hűtőszekrény tönkrement. Az összes étel megromlik. Azonnal újat kell vennetek.", type: "shock", amount: 270000, dayOfMonth: 21,
                    choices: [
                        { id: "pay", text: "Új hűtő vásárlása (270 000 Ft)", effects: { money_multiplier: -1, social: -4, well_being: -10 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (hűtőtáskák)", effects: { money_multiplier: 0, social: -30, well_being: -40 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_boiler", title: "Elromlott a kazán", message: "Tél közepén tönkrement a melegvíz-kazán ('cirkó'). A sürgősségi csere 525 000 Ft.", type: "shock", amount: 525000, dayOfMonth: 10,
                    choices: [
                        { id: "pay", text: "Azonnali csere (525 000 Ft)", effects: { money_multiplier: -1, social: -10, well_being: -30 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (víz forralása)", effects: { money_multiplier: 0, social: -50, well_being: -60 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_laptop_broke", title: "Tönkrement a laptop", message: "A 18 éves laptopja tönkrement, pont a vizsgái előtt. Szüksége van egy újra az iskolához.", type: "shock", amount: 375000, dayOfMonth: 14,
                    choices: [
                        { id: "pay", text: "Új laptop vásárlása (375 000 Ft)", effects: { money_multiplier: -1, social: 6, well_being: -10 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (könyvtár használata)", effects: { money_multiplier: 0, social: -20, well_being: -30 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_dental", title: "Sürgős fogászati kezelés", message: "A 14 évesnek súlyos fogfájása van, és sürgős gyökérkezelésre van szüksége, amit a biztosítás nem fedez teljesen.", type: "shock", amount: 180000, dayOfMonth: 22,
                    choices: [
                        { id: "pay", text: "Fizetés a fogorvosnak (180 000 Ft)", effects: { money_multiplier: -1, social: 0, well_being: -10 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (fájdalomcsillapítók)", effects: { money_multiplier: 0, social: -20, well_being: -40 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_tax_bill", title: "Váratlan adótartozás", message: "Levél érkezett a NAV-tól. Egy tavalyi elszámolási hiba miatt azonnal be kell fizetnetek 140 000 Ft-ot.", type: "shock", amount: 140000, dayOfMonth: 19,
                    choices: [
                        { id: "pay", text: "Számla fizetése (140 000 Ft)", effects: { money_multiplier: -1, social: -4, well_being: -16 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (részletfizetés kérése)", effects: { money_multiplier: 0, social: -10, well_being: -24 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_speeding_ticket", title: "Gyorshajtási bírság", message: "Lefotózott egy traffipax. 110 000 Ft-os bírság érkezett postán.", type: "shock", amount: 110000, dayOfMonth: 9,
                    choices: [
                        { id: "pay", text: "Bírság fizetése (110 000 Ft)", effects: { money_multiplier: -1, social: -6, well_being: -10 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (figyelmen kívül hagyás)", effects: { money_multiplier: 0, social: -16, well_being: -20 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_switchboard", title: "Elektromos kapcsolótábla leégett", message: "A lakás felében nincs áram. A villanyszerelő szerint leégett a fő kapcsolótábla, és ki kell cserélni.", type: "shock", amount: 240000, dayOfMonth: 24,
                    choices: [
                        { id: "pay", text: "Azonnali csere (240 000 Ft)", effects: { money_multiplier: -1, social: -4, well_being: -16 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (hosszabbítók használata)", effects: { money_multiplier: 0, social: -30, well_being: -30 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_school_uniforms", title: "Kötelező egyenruha", message: "Mindkét gyerek nagyot nőtt, és kinőtték a kötelező iskolai egyenruhát. Újakat kell vennetek.", type: "shock", amount: 80000, dayOfMonth: 7,
                    choices: [
                        { id: "pay", text: "Új egyenruhák vásárlása (80 000 Ft)", effects: { money_multiplier: -1, social: 6, well_being: 4 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (kihúzzátok valahogy)", effects: { money_multiplier: 0, social: -16, well_being: -10 }, action: "add_to_debt" }
                    ]
                },
                { id: "shock_sickness", title: "Betegség", message: "A rossz étrend megtette a hatását. A gyerekek betegek lettek, és ki kellett hagynod a munkát (Orvosi költségek és kiesett bér).", type: "shock", amount: 110000, dayOfMonth: 23,
                    choices: [
                        { id: "pay", text: "Számlák fizetése (110 000 Ft)", effects: { money_multiplier: -1, social: -20, well_being: -30 }, action: null },
                        { id: "defer", text: "Adóssághoz adás", effects: { money_multiplier: 0, social: -30, well_being: -40 }, action: "add_to_debt" }
                    ]
                },
                 { id: "shock_broken_arm", title: "Kartörés", message: "A fiatalabbik gyerek sportolás közben elesett, és eltört a karja. A gipszelés és a kórházi ellátás önrésze esedékes.", type: "shock", amount: 70000, dayOfMonth: 25,
                    choices: [
                        { id: "pay", text: "Számla fizetése (70 000 Ft)", effects: { money_multiplier: -1, social: -4, well_being: -16 }, action: null },
                        { id: "defer", text: "Adóssághoz adás (részletfizetés kérése)", effects: { money_multiplier: 0, social: -10, well_being: -24 }, action: "add_to_debt" }
                    ]
                }
            ]
        };

        // ==================================================================
        // 4. GAME ENGINE FUNCTIONS (MODIFIED FLOW)
        // ==================================================================

        function init() {
            gameState.nickname = nicknameInput.value || "Játékos 1";
            loginScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            // Create segments for bars
            createBarSegments(moneyBarContainer, 20);
            createBarSegments(debtBarContainer, 20);
            
            startMonth();
        }

        // NEW: Function to create bar segments
        function createBarSegments(container, count) {
            container.innerHTML = ''; // Clear existing
            for (let i = 0; i < count; i++) {
                const segment = document.createElement('div');
                segment.className = 'bar-segment';
                container.appendChild(segment);
            }
        }

        /**
         * Starts a new month (MODIFIED)
         */
        function startMonth() {
            
            if (gameState.consecutiveDebtMonths >= 6) {
                return gameOver(`Nem sikerült 6 egymást követő hónapban kifizetni az adósságaitokat, ezért csődbe mentetek!`);
            }

            // 1. Add Salary
            gameState.money += gameState.salary;
            
            // 2. Add recurring costs
            for (const cost of gameState.recurringCosts) {
                if (gameState.money >= cost.amount) {
                    gameState.money -= cost.amount;
                } else {
                    addEventToDebt(cost, cost.amount, "add_to_debt");
                }
            }

            // 3. Apply 10% interest and update debt counter
            let debtWarningMessage = "";
            if (gameState.debtHistory.length > 0) {
                gameState.consecutiveDebtMonths++; // Increment debt counter
                let interest = 0;
                gameState.debtHistory.forEach(item => {
                    let itemInterest = Math.round(item.amount * 0.10);
                    item.amount += itemInterest;
                    interest += itemInterest;
                });
                
                debtWarningMessage = `A ki nem fizettett adósságaitok ${formatCurrency(interest)}-al nőttek (10% díj).
                \n${gameState.consecutiveDebtMonths} hónapja vagytok adósságban. 
                \nHa eléritek a 6 hónapot, csődbe mentek!`;

            } else {
                gameState.consecutiveDebtMonths = 0; // Reset counter if debt is 0
            }

            // 4. Update UI *before* showing modal
            updateUI();

            // 5. MODIFIED FLOW: Show debt warning, *then* obligatory modal
            if (debtWarningMessage) {
                // Show warning first, then open bills modal on continue
                eventPanel.classList.remove('hidden'); // Show event panel for this message
                displayMessage("Adósság Figyelmeztetés", debtWarningMessage, [{text: "Tovább a számlákhoz"}], () => {
                    openObligatoryModal();
                });
            } else {
                // No warning, go straight to bills modal
                openObligatoryModal();
            }
        }
        
        // NEW: Open and populate the obligatory costs modal
        function openObligatoryModal() {
            eventPanel.classList.add('hidden'); // Hide main event panel
            processedObligatoryCount = 0;
            obligatoryTableBody.innerHTML = '';
            obligatoryModalError.textContent = '';
            
            let currentObligatory = JSON.parse(JSON.stringify(allEvents.obligatory));
            if (gameState.carSold) {
                currentObligatory = currentObligatory.filter(event => !event.id.includes('car_') && !event.id.includes('fuel'));
            }
            totalObligatoryCosts = currentObligatory.length;
            
            if (totalObligatoryCosts === 0) {
                btnObligatoryContinue.disabled = false;
                obligatoryModal.classList.remove('hidden');
                return;
            }

            btnObligatoryContinue.disabled = true;

            currentObligatory.forEach(event => {
                const row = document.createElement('tr');
                row.className = 'obligatory-row';
                row.dataset.eventId = event.id;
                row.dataset.eventAmount = event.amount; // Store amount for easier access

                row.innerHTML = `
                    <td>${event.title}</td>
                    <td class="cost-amount">${formatCurrency(event.amount)}</td>
                    <td class="obligatory-actions">
                        <button class="btn btn-primary btn-pay-obligatory" data-choice="pay">Fizet</button>
                        <button class="btn btn-secondary btn-defer-obligatory" data-choice="later">Halaszt</button>
                        <button class="btn btn-accent btn-deny-obligatory" data-choice="deny"></button>
                    </td>
                `;
                obligatoryTableBody.appendChild(row);
            });
            
            // Add listeners
            obligatoryTableBody.querySelectorAll('.obligatory-actions button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    const eventId = row.dataset.eventId;
                    const choiceId = e.target.dataset.choice;
                    handleObligatoryChoice(eventId, choiceId, row);
                });
            });

            updateObligatoryButtonStates(); // Set initial disabled states
            obligatoryModal.classList.remove('hidden');
        }

        // NEW: Handle clicks from the obligatory modal
        function handleObligatoryChoice(eventId, choiceId, rowElement) {
            obligatoryModalError.textContent = ''; // Clear error
            const event = allEvents.obligatory.find(e => e.id === eventId);
            if (!event) return;

            const choice = event.choices.find(c => c.id === choiceId);
            if (!choice) return;

            // Check for affordability *before* processing
            if (choiceId === 'pay') {
                if (gameState.money < event.amount) {
                    obligatoryModalError.textContent = "Nincs elég pénzed ennek a kifizetésére!";
                    return;
                }
                gameState.money -= event.amount;
            }

            // Apply stat effects
            applyEffects(choice.effects);
            
            // Add to debt if needed
            if (choice.action === 'defer' || choice.action === 'add_to_debt') {
                addEventToDebt(event, event.amount, choice.action);
            }

            // Update main UI (money, debt, stats)
            updateUI();
            
            // Update the row in the modal to show status
            let statusText = '';
            let statusClass = '';
            switch(choiceId) {
                case 'pay': statusText = 'Fizetve'; statusClass = 'status-paid'; break;
                case 'later': statusText = 'Elhalasztva'; statusClass = 'status-deferred'; break;
                case 'deny': statusText = 'Elutasítva'; statusClass = 'status-denied'; break;
            }
            rowElement.querySelector('.obligatory-actions').innerHTML = `<span class="obligatory-status ${statusClass}">${statusText}</span>`;
            
            // Mark as processed
            rowElement.classList.add('processed');
            processedObligatoryCount++;
            
            // Check if all items are processed
            if (processedObligatoryCount === totalObligatoryCosts) {
                btnObligatoryContinue.disabled = false;
            }
            
            // Re-check all other pay buttons
            updateObligatoryButtonStates();
        }
        
        // NEW: Check affordability of all "Pay" buttons in the table
        function updateObligatoryButtonStates() {
             obligatoryTableBody.querySelectorAll('tr:not(.processed)').forEach(row => {
                const amount = parseInt(row.dataset.eventAmount, 10);
                const payButton = row.querySelector('.btn-pay-obligatory');
                if (payButton) {
                    payButton.disabled = gameState.money < amount;
                }
             });
        }

        // NEW: Listener for the continue button
        btnObligatoryContinue.addEventListener('click', () => {
            obligatoryModal.classList.add('hidden');
            
            // Now build the queue for the rest of the month
            buildMonthlyQueue();
            
            // And start processing them
            processNextEvent();
        });


        // MODIFIED: Build queue *without* obligatory costs
        function buildMonthlyQueue() {
            gameState.monthlyEventQueue = [];
            
            // OBLIGATORY COSTS ARE NO LONGER ADDED HERE
            
            gameState.monthlyEventQueue.push(...JSON.parse(JSON.stringify(allEvents.special)));
            
            gameState.monthlyEventQueue.push(...gameState.snoozedEvents.map(item => item.event));
            gameState.snoozedEvents = []; 

            // Pick 4 random optional events
            let optionalPool = [...allEvents.optional];
            let eventsToPick = (gameState.currentMonth === 0) ? 2 : 4; // Fewer in first month
            
            for (let i = 0; i < eventsToPick; i++) {
                if (optionalPool.length === 0) break;
                let randIndex = Math.floor(Math.random() * optionalPool.length);
                gameState.monthlyEventQueue.push(optionalPool.splice(randIndex, 1)[0]);
            }

            // Add 5 random opportunities (Increased from 4)
            let opportunityPool = [...allEvents.opportunity];
            if (gameState.carSold) {
                opportunityPool = opportunityPool.filter(event => event.id !== 'job_sell_car');
            }
            // --- CHANGE: Increased loop count from 4 to 5 ---
            for (let i = 0; i < 5; i++) { 
                 if (opportunityPool.length === 0) break;
                 let oppRandIndex = Math.floor(Math.random() * opportunityPool.length);
                 gameState.monthlyEventQueue.push(opportunityPool.splice(oppRandIndex, 1)[0]);
            }

            // Add a SHOCK event (but not in Month 1)
            if (gameState.currentMonth > 0) {
                let shockPool = [...allEvents.shock];
                let healthShockProbability = 0.6; // 60%
                
                if (gameState.cheapFoodStreak >= 2 && Math.random() < healthShockProbability) {
                    let healthShocks = ['shock_sickness', 'shock_dental', 'shock_broken_arm'];
                    let randHealthShock = healthShocks[Math.floor(Math.random() * healthShocks.length)];
                    gameState.monthlyEventQueue.push(shockPool.find(e => e.id === randHealthShock));
                } else {
                    let nonHealthShocks = shockPool.filter(e => !['shock_sickness', 'shock_dental', 'shock_broken_arm'].includes(e.id));
                    if (nonHealthShocks.length > 0) {
                         let randShock = nonHealthShocks[Math.floor(Math.random() * nonHealthShocks.length)];
                         gameState.monthlyEventQueue.push(randShock);
                    }
                }
            }

            gameState.monthlyEventQueue.sort((a, b) => a.dayOfMonth - b.dayOfMonth);
        }

        function processNextEvent() {
            if (gameState.monthlyEventQueue.length === 0) {
                endMonth();
                return;
            }

            const event = gameState.monthlyEventQueue.shift();
            if (event) {
                // Set date and display the event
                let monthName = gameState.monthNames[gameState.currentMonth];
                gameDate.textContent = `Év ${gameState.currentYear}, ${monthName} ${event.dayOfMonth}`;
                eventPanel.classList.remove('hidden'); // Make sure it's visible
                displayEvent(event);
            } else {
                processNextEvent();
            }
        }

        /**
         * Displays a single event (NOT obligatory ones)
         */
        function displayEvent(event) {
            let titleText = event.title;
            if (event.amount && event.amount > 0) {
                titleText += ` (${formatCurrency(event.amount)})`;
            } else if (event.type === 'opportunity' && event.choices[0].effects.money > 0) {
                if (event.choices.length === 1) {
                     titleText += ` (+${formatCurrency(event.choices[0].effects.money)})`;
                }
            }
            eventTitle.textContent = titleText;

            eventMessage.innerHTML = event.message.replace(/\n/g, '<br>'); // Use .innerHTML
            eventChoices.innerHTML = "";
            
            if (event.type === 'optional') {
                const btnYes = document.createElement('button');
                btnYes.className = 'btn btn-primary';
                btnYes.textContent = `Igen (${formatCurrency(event.amount)})`; // Translated
                btnYes.onclick = () => handleOptionalChoice(event, true);
                eventChoices.appendChild(btnYes);

                const btnNo = document.createElement('button');
                btnNo.className = 'btn btn-accent';
                btnNo.textContent = `Nem`; // Translated
                btnNo.onclick = () => handleOptionalChoice(event, false);
                eventChoices.appendChild(btnNo);

            } else {
                // Handle single-choice events (like tax refund)
                if (event.choices.length === 1) {
                     const choice = event.choices[0];
                     const btn = document.createElement('button');
                     btn.className = 'btn btn-primary';
                     btn.textContent = choice.text;
                     btn.onclick = () => handleChoice(choice, event);
                     eventChoices.appendChild(btn);
                } else {
                // Handle standard multi-choice events
                    event.choices.forEach(choice => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-primary';
                        // Style mapping remains the same
                        if (choice.id.includes('later')) btn.className = 'btn btn-secondary';
                        if (choice.id.includes('deny') || choice.id.includes('no')) btn.className = 'btn btn-accent';

                        btn.textContent = choice.text; // Already translated in database
                        btn.onclick = () => handleChoice(choice, event);
                        eventChoices.appendChild(btn);
                    });
                }
            }
        }
        
        function handleOptionalChoice(event, didAccept) {
            if (didAccept) {
                if (gameState.money >= event.amount) {
                    gameState.money -= event.amount;
                    applyEffects(event.effects_yes);

                    if (event.recurring) {
                        gameState.recurringCosts.push({ id: event.id, title: event.title, amount: event.amount });
                    }
                } else {
                    // Translated
                    displayMessage("Nincs elég pénz", "Nincs elég pénzed ehhez.", [{text: "Értettem"}], () => processNextEvent());
                    return;
                }
            } else {
                applyEffects(event.effects_no);
                if (event.nag) {
                    gameState.snoozedEvents.push({ event });
                }
            }
            
            updateUI();
            if (checkLossConditions()) return;
            processNextEvent();
        }

        function handleChoice(choice, event) {
            if (choice.effects.money_multiplier) {
                let cost = event.amount * choice.effects.money_multiplier;
                gameState.money += cost;
            }
            if (choice.effects.money) {
                gameState.money += choice.effects.money;
            }

            applyEffects(choice.effects);
            
            // This logic is now only for SHOCKS, not obligatory
            if (choice.action === 'defer' || choice.action === 'add_to_debt') {
                addEventToDebt(event, event.amount, choice.action);
            }
            if (choice.action === 'cheap_food') {
                gameState.cheapFoodStreak++;
            }
            if (choice.action === 'quality_food') {
                gameState.cheapFoodStreak = 0;
            }
            if (choice.action === 'sell_car') {
                gameState.carSold = true;
                // No need to filter recurring costs here, already done
            }

            updateUI();
            
            if (checkLossConditions()) return;
            
            processNextEvent();
        }
        
        function endMonth() {
            gameState.currentMonth++;
            if (gameState.currentMonth > 11) {
                gameState.currentMonth = 0;
                gameState.currentYear++;
            }
            
            let lastMonthName = gameState.monthNames[gameState.currentMonth === 0 ? 11 : gameState.currentMonth - 1];
            
            // Translated
            eventPanel.classList.remove('hidden'); // Ensure panel is visible
            displayMessage("Hónap Vége", `Véget ért ${lastMonthName}. Készülj a következő hónapra...`, [{text: "Következő Hónap Indítása"}], () => startMonth());
        }

        // ==================================================================
        // 5. UI & STATE UPDATE FUNCTIONS (Translated)
        // ==================================================================

        function applyEffects(effects) {
            if (effects.social) {
                gameState.social = clamp(gameState.social + effects.social, 0, 100);
            }
            if (effects.well_being) {
                gameState.well_being = clamp(gameState.well_being + effects.well_being, 0, 100);
            }
        }

        // NEW: Function to update segmented bars
        function updateSegmentedBar(container, value, max, className) {
            const segments = container.querySelectorAll('.bar-segment');
            const numSegments = segments.length;
            let percent = clamp((value / max) * 100, 0, 100);
            let segmentsToFill = Math.ceil((percent / 100) * numSegments);

            segments.forEach((segment, index) => {
                if (index < segmentsToFill) {
                    segment.classList.add(className);
                } else {
                    segment.classList.remove(className);
                }
            });
        }

        function updateUI() {
            moneyLabel.textContent = formatCurrency(gameState.money);
            updateSegmentedBar(moneyBarContainer, gameState.money, gameState.maxMoney, 'filled-money');
            
            let totalDebt = gameState.debtHistory.reduce((sum, item) => sum + item.amount, 0);
            gameState.debt = totalDebt;
            debtLabel.textContent = formatCurrency(totalDebt);
            updateSegmentedBar(debtBarContainer, totalDebt, gameState.maxDebt, 'filled-debt');

            socialPercent.textContent = `${gameState.social}%`;
            socialGauge.style.setProperty('--p-social', gameState.social);
            
            wellbeingPercent.textContent = `${gameState.well_being}%`;
            wellbeingGauge.style.setProperty('--p-wellbeing', gameState.well_being);
        }

        function checkLossConditions() {
            if (gameState.social <= 0) {
                // Translated
                gameOver("A közösségi kapcsolataid összeomlottak. Elvesztetted a játékot.");
                return true;
            }
            if (gameState.well_being <= 0) {
                // Translated
                gameOver("A személyes jóléted nullára csökkent. Az egészséged és a családi életed összeomlott. Elvesztetted a játékot.");
                return true;
            }
            return false;
        }

        function gameOver(message) {
            eventPanel.classList.remove('hidden'); // Ensure panel is visible
            displayMessage("Játék Vége", message, [], () => {}); // Translated
            eventChoices.innerHTML = ""; 
        }

        function displayMessage(title, message, choices, callback) {
            eventTitle.textContent = title;
            eventMessage.innerHTML = message.replace(/\n/g, '<br>'); // Use .innerHTML
            eventChoices.innerHTML = "";
            
            if (choices.length === 0) return; 

            const btn = document.createElement('button');
            btn.className = 'btn btn-primary';
            btn.textContent = choices[0].text; // Already translated
            btn.onclick = callback;
            eventChoices.appendChild(btn);
        }

        // ==================================================================
        // 6. MODAL & DEBT FUNCTIONS (Translated + Alert fix)
        // ==================================================================

        function addEventToDebt(event, amount, action) {
            let existingDebt = gameState.debtHistory.find(item => item.event.id === event.id);
            if (existingDebt) {
                existingDebt.amount += amount;
            } else {
                gameState.debtHistory.push({
                    event: event,
                    amount: amount
                });
            }
        }

        function openModal(modal) {
            if (modal === 'debt') {
                populateDebtModal();
                debtModal.classList.remove('hidden');
            } else if (modal === 'log') {
                populateLogModal();
                logModal.classList.remove('hidden');
            }
        }

        function closeModal(modal) {
            if (modal === 'debt') {
                debtModal.classList.add('hidden');
            } else if (modal === 'log') {
                logModal.classList.add('hidden');
            }
        }

        function populateDebtModal() {
            debtModalBody.innerHTML = "";
            debtModalError.textContent = ""; // Clear error
            if (gameState.debtHistory.length === 0) {
                // Translated
                debtModalBody.innerHTML = "<p>Nincsenek fennálló adósságaid. Szép munka!</p>";
                return;
            }
            
            gameState.debtHistory.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'log-item';
                el.innerHTML = `
                    <div class="log-item-info">
                        <strong>${item.event.title}:</strong> 
                        <span>${formatCurrency(item.amount)}</span>
                    </div>
                    <div class="log-item-actions">
                        <button class="btn btn-primary btn-pay-debt" data-index="${index}">Fizetés most</button>
                    </div>
                `; // Translated
                debtModalBody.appendChild(el);
            });

            document.querySelectorAll('.btn-pay-debt').forEach(btn => {
                btn.onclick = (e) => {
                    let index = e.target.dataset.index;
                    payDebtItem(index);
                };
            });
        }
        
        function payDebtItem(index) {
            const item = gameState.debtHistory[index];
            if (gameState.money >= item.amount) {
                gameState.money -= item.amount;
                gameState.debtHistory.splice(index, 1); 
                updateUI();
                populateDebtModal(); // Repopulate to clear error and update list
            } else {
                // Translated + Alert fix
                debtModalError.textContent = "Nincs elég pénzed kifizetni ezt az adósságot!";
            }
        }
        
        function populateLogModal() {
            logModalBody.innerHTML = "";
            logModalError.textContent = ""; // Clear error
            let allSnoozed = [...gameState.snoozedEvents]; 
            
            gameState.recurringCosts.forEach(cost => {
                allSnoozed.push({
                    event: { id: cost.id, title: `Lemondás: ${cost.title}`, amount: 0, recurring: true, effects_no: { social: 0, well_being: 0 } }
                }); // Translated "Cancel"
            });

            if (allSnoozed.length === 0) {
                // Translated
                logModalBody.innerHTML = "<p>Nincsenek elhalasztott opcionális eseményeid.</p>";
                return;
            }

            allSnoozed.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'log-item';
                // Translated "Cancel" and "Accept"
                let text = item.event.recurring ? `Lemondás` : `Elfogadás (${formatCurrency(item.event.amount)})`;
                el.innerHTML = `
                    <div class="log-item-info">
                        <strong>${item.event.title}</strong>
                    </div>
                    <div class="log-item-actions">
                        <button class="btn ${item.event.recurring ? 'btn-accent' : 'btn-primary'} btn-accept-log" data-index="${index}">
                            ${text}
                        </button>
                    </div>
                `;
                logModalBody.appendChild(el);
            });
            
            document.querySelectorAll('.btn-accept-log').forEach(btn => {
                btn.onclick = (e) => {
                    let index = e.target.dataset.index;
                    acceptLogItem(index);
                };
            });
        }
        
        function acceptLogItem(index) {
             let allSnoozed = [
                ...gameState.snoozedEvents, 
                ...gameState.recurringCosts.map(cost => ({
                    event: { id: cost.id, title: `Lemondás: ${cost.title}`, amount: 0, recurring: true, effects_no: { social: 0, well_being: 0 } }
                })) // Translated
            ];

            const item = allSnoozed[index];
            
            if (item.event.recurring) {
                gameState.recurringCosts = gameState.recurringCosts.filter(cost => cost.id !== item.event.id);
                gameState.snoozedEvents = gameState.snoozedEvents.filter(e => e.event.id !== item.event.id);
            } else {
                if (gameState.money >= item.event.amount) {
                    gameState.money -= item.event.amount;
                    applyEffects(item.event.effects_yes || {});
                    if (item.event.recurring) {
                        gameState.recurringCosts.push({ id: item.event.id, title: item.event.title, amount: item.event.amount });
                    }
                    gameState.snoozedEvents = gameState.snoozedEvents.filter(e => e.event.id !== item.event.id);
                } else {
                    // Translated + Alert fix
                    logModalError.textContent = "Nincs elég pénzed ehhez!";
                }
            }
            updateUI();
            populateLogModal(); 
        }

        // ==================================================================
        // 7. HELPER FUNCTIONS
        // ==================================================================
        
        function formatCurrency(value) {
            // Already set to hu-HU, no change needed
            return new Intl.NumberFormat('hu-HU', { style: 'currency', currency: 'HUF', maximumFractionDigits: 0 }).format(value);
        }

        function clamp(value, min, max) {
            return Math.max(min, Math.min(value, max));
        }

        // ==================================================================
        // 8. INITIALIZATION
        // ==================================================================
        
        startGameBtn.onclick = init;

        // New listeners for persona buttons
        personaMaleBtn.onclick = () => {
            personaMaleBtn.classList.add('active');
            personaFemaleBtn.classList.remove('active');
        };
        personaFemaleBtn.onclick = () => {
            personaFemaleBtn.classList.add('active');
            personaMaleBtn.classList.remove('active');
        };

        btnLog.onclick = () => openModal('log');
        btnDebt.onclick = () => openModal('debt');
        btnLogClose.onclick = () => closeModal('log');
        btnDebtClose.onclick = () => closeModal('debt');
        
        logModal.onclick = (e) => {
            if (e.target === logModal) closeModal('log');
        };
        debtModal.onclick = (e) => {
            if (e.target === debtModal) closeModal('debt');
        };

    });
    </script>

</body>
</html>

